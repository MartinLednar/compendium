"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.SFNPutNodes = void 0;
const aws_stepfunctions_1 = require("aws-cdk-lib/aws-stepfunctions");
const aws_stepfunctions_tasks_1 = require("aws-cdk-lib/aws-stepfunctions-tasks");
const execute_statement_1 = require("./aws-stepfunctions-tasks/dynamodb/execute-statement");
class SFNPutNodes extends aws_stepfunctions_1.StateMachine {
    constructor(scope, id, props) {
        const definition = SFNPutNodes.getDefinition(scope, id, props);
        super(scope, `${id}PutNode`, {
            definition,
            stateMachineType: aws_stepfunctions_1.StateMachineType.STANDARD,
            ...props,
        });
    }
    static getDefinition(scope, id, { dynamoTable }) {
        const putNode = new aws_stepfunctions_tasks_1.DynamoPutItem(scope, `${id}PutItem`, {
            table: dynamoTable,
            resultPath: aws_stepfunctions_1.JsonPath.stringAt("$.result"),
            item: {
                PK: aws_stepfunctions_tasks_1.DynamoAttributeValue.fromString(aws_stepfunctions_1.JsonPath.format("NODE|{}", aws_stepfunctions_1.JsonPath.stringAt("$.node.id"))),
                SK: aws_stepfunctions_tasks_1.DynamoAttributeValue.fromString(aws_stepfunctions_1.JsonPath.format("NODE|{}", aws_stepfunctions_1.JsonPath.stringAt("$.node.id"))),
                GSI1PK: aws_stepfunctions_tasks_1.DynamoAttributeValue.fromString("NODES|RECENT"),
                GSI1SK: aws_stepfunctions_tasks_1.DynamoAttributeValue.fromString(aws_stepfunctions_1.JsonPath.format("{}|{}", aws_stepfunctions_1.JsonPath.stringAt("$$.Execution.StartTime"), aws_stepfunctions_1.JsonPath.stringAt("$.node.id"))),
                id: aws_stepfunctions_tasks_1.DynamoAttributeValue.fromString(aws_stepfunctions_1.JsonPath.stringAt("$.node.id")),
                name: aws_stepfunctions_tasks_1.DynamoAttributeValue.fromString(aws_stepfunctions_1.JsonPath.stringAt("$.node.name")),
                metadata: aws_stepfunctions_tasks_1.DynamoAttributeValue.fromString(aws_stepfunctions_1.JsonPath.jsonToString(aws_stepfunctions_1.JsonPath.objectAt("$.node.metadata"))),
                version: aws_stepfunctions_tasks_1.DynamoAttributeValue.fromString(aws_stepfunctions_1.JsonPath.stringAt("$$.Execution.StartTime")),
            },
        });
        const storeDependeeEdge = new aws_stepfunctions_tasks_1.DynamoPutItem(scope, `${id}StoreDependeeEdge`, {
            table: dynamoTable,
            resultPath: aws_stepfunctions_1.JsonPath.DISCARD,
            item: {
                PK: aws_stepfunctions_tasks_1.DynamoAttributeValue.fromString(aws_stepfunctions_1.JsonPath.format("NODE|{}", aws_stepfunctions_1.JsonPath.stringAt("$.node.id"))),
                SK: aws_stepfunctions_tasks_1.DynamoAttributeValue.fromString(aws_stepfunctions_1.JsonPath.format("DEPENDENCY|NODE|{}", aws_stepfunctions_1.JsonPath.stringAt("$.dependency"))),
                dependencyId: aws_stepfunctions_tasks_1.DynamoAttributeValue.fromString(aws_stepfunctions_1.JsonPath.format("NODE|{}", aws_stepfunctions_1.JsonPath.stringAt("$.dependency"))),
                dependantId: aws_stepfunctions_tasks_1.DynamoAttributeValue.fromString(aws_stepfunctions_1.JsonPath.format("NODE|{}", aws_stepfunctions_1.JsonPath.stringAt("$.node.id"))),
                dependantVersion: aws_stepfunctions_tasks_1.DynamoAttributeValue.fromString(aws_stepfunctions_1.JsonPath.stringAt("$$.Execution.StartTime")),
            },
        });
        const getOutdatedDependencies = new execute_statement_1.DynamoExecuteStatement(scope, `${id}GetOutdatedDependencies`, {
            table: dynamoTable,
            statement: aws_stepfunctions_1.JsonPath.format(`SELECT * FROM "${dynamoTable.tableName}" WHERE PK = 'NODE|{}' AND begins_with(SK,'DEPENDENCY|NODE|') AND dependantVersion < ?`, aws_stepfunctions_1.JsonPath.stringAt("$.node.id")),
            parameters: [
                aws_stepfunctions_tasks_1.DynamoAttributeValue.fromString(aws_stepfunctions_1.JsonPath.stringAt("$$.Execution.StartTime")),
            ],
            resultPath: aws_stepfunctions_1.JsonPath.stringAt("$.invalidDependencies"),
        });
        const deleteOutdatedDependencie = new aws_stepfunctions_tasks_1.DynamoDeleteItem(scope, `${id}GetOutdatedDependencie`, {
            table: dynamoTable,
            key: {
                PK: aws_stepfunctions_tasks_1.DynamoAttributeValue.fromString(aws_stepfunctions_1.JsonPath.stringAt("$.dependency.PK.S")),
                SK: aws_stepfunctions_tasks_1.DynamoAttributeValue.fromString(aws_stepfunctions_1.JsonPath.stringAt("$.dependency.SK.S")),
            },
            resultPath: aws_stepfunctions_1.JsonPath.stringAt("$.invalidDependencies"),
        });
        return new aws_stepfunctions_1.Map(scope, "MapPutNodes", {
            itemsPath: aws_stepfunctions_1.JsonPath.stringAt("$.nodes"),
            parameters: {
                node: aws_stepfunctions_1.JsonPath.stringAt("$$.Map.Item.Value"),
            },
        }).iterator(putNode
            .next(new aws_stepfunctions_1.Map(scope, "StoreDependencies", {
            itemsPath: aws_stepfunctions_1.JsonPath.stringAt("$.node.dependencies"),
            parameters: {
                dependency: aws_stepfunctions_1.JsonPath.stringAt("$$.Map.Item.Value"),
                node: aws_stepfunctions_1.JsonPath.stringAt("$.node"),
            },
            resultPath: aws_stepfunctions_1.JsonPath.DISCARD,
        }).iterator(storeDependeeEdge))
            .next(getOutdatedDependencies.next(new aws_stepfunctions_1.Map(scope, "DeleteOutdatedDependencies", {
            itemsPath: aws_stepfunctions_1.JsonPath.stringAt("$.invalidDependencies.Items"),
            parameters: {
                dependency: aws_stepfunctions_1.JsonPath.stringAt("$$.Map.Item.Value"),
                node: aws_stepfunctions_1.JsonPath.stringAt("$.node"),
            },
        }).iterator(deleteOutdatedDependencie))));
    }
}
exports.SFNPutNodes = SFNPutNodes;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2ZuLXB1dC1ub2RlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsic2ZuLXB1dC1ub2RlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLHFFQU91QztBQUN2QyxpRkFJNkM7QUFFN0MsNEZBQThGO0FBTTlGLE1BQWEsV0FBWSxTQUFRLGdDQUFZO0lBQzNDLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBdUI7UUFDL0QsTUFBTSxVQUFVLEdBQUcsV0FBVyxDQUFDLGFBQWEsQ0FBQyxLQUFLLEVBQUUsRUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQy9ELEtBQUssQ0FBQyxLQUFLLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRTtZQUMzQixVQUFVO1lBQ1YsZ0JBQWdCLEVBQUUsb0NBQWdCLENBQUMsUUFBUTtZQUMzQyxHQUFHLEtBQUs7U0FDVCxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU8sTUFBTSxDQUFDLGFBQWEsQ0FDMUIsS0FBZ0IsRUFDaEIsRUFBVSxFQUNWLEVBQUUsV0FBVyxFQUFvQjtRQUVqQyxNQUFNLE9BQU8sR0FBRyxJQUFJLHVDQUFhLENBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUU7WUFDdkQsS0FBSyxFQUFFLFdBQVc7WUFDbEIsVUFBVSxFQUFFLDRCQUFRLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQztZQUN6QyxJQUFJLEVBQUU7Z0JBQ0osRUFBRSxFQUFFLDhDQUFvQixDQUFDLFVBQVUsQ0FDakMsNEJBQVEsQ0FBQyxNQUFNLENBQUMsU0FBUyxFQUFFLDRCQUFRLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQzNEO2dCQUNELEVBQUUsRUFBRSw4Q0FBb0IsQ0FBQyxVQUFVLENBQ2pDLDRCQUFRLENBQUMsTUFBTSxDQUFDLFNBQVMsRUFBRSw0QkFBUSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUMzRDtnQkFDRCxNQUFNLEVBQUUsOENBQW9CLENBQUMsVUFBVSxDQUFDLGNB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QXZJRCxrQ0F1SUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUYWJsZSB9IGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtZHluYW1vZGJcIjtcbmltcG9ydCB7XG4gIElDaGFpbmFibGUsXG4gIEpzb25QYXRoLFxuICBNYXAsXG4gIFN0YXRlTWFjaGluZSxcbiAgU3RhdGVNYWNoaW5lUHJvcHMsXG4gIFN0YXRlTWFjaGluZVR5cGUsXG59IGZyb20gXCJhd3MtY2RrLWxpYi9hd3Mtc3RlcGZ1bmN0aW9uc1wiO1xuaW1wb3J0IHtcbiAgRHluYW1vQXR0cmlidXRlVmFsdWUsXG4gIER5bmFtb0RlbGV0ZUl0ZW0sXG4gIER5bmFtb1B1dEl0ZW0sXG59IGZyb20gXCJhd3MtY2RrLWxpYi9hd3Mtc3RlcGZ1bmN0aW9ucy10YXNrc1wiO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSBcImNvbnN0cnVjdHNcIjtcbmltcG9ydCB7IER5bmFtb0V4ZWN1dGVTdGF0ZW1lbnQgfSBmcm9tIFwiLi9hd3Mtc3RlcGZ1bmN0aW9ucy10YXNrcy9keW5hbW9kYi9leGVjdXRlLXN0YXRlbWVudFwiO1xuXG5pbnRlcmZhY2UgU0ZOUHV0Tm9kZXNQcm9wcyBleHRlbmRzIE9taXQ8U3RhdGVNYWNoaW5lUHJvcHMsIFwiZGVmaW5pdGlvblwiPiB7XG4gIGR5bmFtb1RhYmxlOiBUYWJsZTtcbn1cblxuZXhwb3J0IGNsYXNzIFNGTlB1dE5vZGVzIGV4dGVuZHMgU3RhdGVNYWNoaW5lIHtcbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IFNGTlB1dE5vZGVzUHJvcHMpIHtcbiAgICBjb25zdCBkZWZpbml0aW9uID0gU0ZOUHV0Tm9kZXMuZ2V0RGVmaW5pdGlvbihzY29wZSwgaWQsIHByb3BzKTtcbiAgICBzdXBlcihzY29wZSwgYCR7aWR9UHV0Tm9kZWAsIHtcbiAgICAgIGRlZmluaXRpb24sXG4gICAgICBzdGF0ZU1hY2hpbmVUeXBlOiBTdGF0ZU1hY2hpbmVUeXBlLlNUQU5EQVJELFxuICAgICAgLi4ucHJvcHMsXG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyBnZXREZWZpbml0aW9uKFxuICAgIHNjb3BlOiBDb25zdHJ1Y3QsXG4gICAgaWQ6IHN0cmluZyxcbiAgICB7IGR5bmFtb1RhYmxlIH06IFNGTlB1dE5vZGVzUHJvcHNcbiAgKTogSUNoYWluYWJsZSB7XG4gICAgY29uc3QgcHV0Tm9kZSA9IG5ldyBEeW5hbW9QdXRJdGVtKHNjb3BlLCBgJHtpZH1QdXRJdGVtYCwge1xuICAgICAgdGFibGU6IGR5bmFtb1RhYmxlLFxuICAgICAgcmVzdWx0UGF0aDogSnNvblBhdGguc3RyaW5nQXQoXCIkLnJlc3VsdFwiKSxcbiAgICAgIGl0ZW06IHtcbiAgICAgICAgUEs6IER5bmFtb0F0dHJpYnV0ZVZhbHVlLmZyb21TdHJpbmcoXG4gICAgICAgICAgSnNvblBhdGguZm9ybWF0KFwiTk9ERXx7fVwiLCBKc29uUGF0aC5zdHJpbmdBdChcIiQubm9kZS5pZFwiKSlcbiAgICAgICAgKSxcbiAgICAgICAgU0s6IER5bmFtb0F0dHJpYnV0ZVZhbHVlLmZyb21TdHJpbmcoXG4gICAgICAgICAgSnNvblBhdGguZm9ybWF0KFwiTk9ERXx7fVwiLCBKc29uUGF0aC5zdHJpbmdBdChcIiQubm9kZS5pZFwiKSlcbiAgICAgICAgKSxcbiAgICAgICAgR1NJMVBLOiBEeW5hbW9BdHRyaWJ1dGVWYWx1ZS5mcm9tU3RyaW5nKFwiTk9ERVN8UkVDRU5UXCIpLFxuICAgICAgICBHU0kxU0s6IER5bmFtb0F0dHJpYnV0ZVZhbHVlLmZyb21TdHJpbmcoXG4gICAgICAgICAgSnNvblBhdGguZm9ybWF0KFxuICAgICAgICAgICAgXCJ7fXx7fVwiLFxuICAgICAgICAgICAgSnNvblBhdGguc3RyaW5nQXQoXCIkJC5FeGVjdXRpb24uU3RhcnRUaW1lXCIpLFxuICAgICAgICAgICAgSnNvblBhdGguc3RyaW5nQXQoXCIkLm5vZGUuaWRcIilcbiAgICAgICAgICApXG4gICAgICAgICksXG4gICAgICAgIGlkOiBEeW5hbW9BdHRyaWJ1dGVWYWx1ZS5mcm9tU3RyaW5nKEpzb25QYXRoLnN0cmluZ0F0KFwiJC5ub2RlLmlkXCIpKSxcbiAgICAgICAgbmFtZTogRHluYW1vQXR0cmlidXRlVmFsdWUuZnJvbVN0cmluZyhKc29uUGF0aC5zdHJpbmdBdChcIiQubm9kZS5uYW1lXCIpKSxcbiAgICAgICAgbWV0YWRhdGE6IER5bmFtb0F0dHJpYnV0ZVZhbHVlLmZyb21TdHJpbmcoXG4gICAgICAgICAgSnNvblBhdGguanNvblRvU3RyaW5nKEpzb25QYXRoLm9iamVjdEF0KFwiJC5ub2RlLm1ldGFkYXRhXCIpKVxuICAgICAgICApLFxuICAgICAgICB2ZXJzaW9uOiBEeW5hbW9BdHRyaWJ1dGVWYWx1ZS5mcm9tU3RyaW5nKFxuICAgICAgICAgIEpzb25QYXRoLnN0cmluZ0F0KFwiJCQuRXhlY3V0aW9uLlN0YXJ0VGltZVwiKVxuICAgICAgICApLFxuICAgICAgfSxcbiAgICB9KTtcbiAgICBjb25zdCBzdG9yZURlcGVuZGVlRWRnZSA9IG5ldyBEeW5hbW9QdXRJdGVtKFxuICAgICAgc2NvcGUsXG4gICAgICBgJHtpZH1TdG9yZURlcGVuZGVlRWRnZWAsXG4gICAgICB7XG4gICAgICAgIHRhYmxlOiBkeW5hbW9UYWJsZSxcbiAgICAgICAgcmVzdWx0UGF0aDogSnNvblBhdGguRElTQ0FSRCxcbiAgICAgICAgaXRlbToge1xuICAgICAgICAgIFBLOiBEeW5hbW9BdHRyaWJ1dGVWYWx1ZS5mcm9tU3RyaW5nKFxuICAgICAgICAgICAgSnNvblBhdGguZm9ybWF0KFwiTk9ERXx7fVwiLCBKc29uUGF0aC5zdHJpbmdBdChcIiQubm9kZS5pZFwiKSlcbiAgICAgICAgICApLFxuICAgICAgICAgIFNLOiBEeW5hbW9BdHRyaWJ1dGVWYWx1ZS5mcm9tU3RyaW5nKFxuICAgICAgICAgICAgSnNvblBhdGguZm9ybWF0KFxuICAgICAgICAgICAgICBcIkRFUEVOREVOQ1l8Tk9ERXx7fVwiLFxuICAgICAgICAgICAgICBKc29uUGF0aC5zdHJpbmdBdChcIiQuZGVwZW5kZW5jeVwiKVxuICAgICAgICAgICAgKVxuICAgICAgICAgICksXG4gICAgICAgICAgZGVwZW5kZW5jeUlkOiBEeW5hbW9BdHRyaWJ1dGVWYWx1ZS5mcm9tU3RyaW5nKFxuICAgICAgICAgICAgSnNvblBhdGguZm9ybWF0KFwiTk9ERXx7fVwiLCBKc29uUGF0aC5zdHJpbmdBdChcIiQuZGVwZW5kZW5jeVwiKSlcbiAgICAgICAgICApLFxuICAgICAgICAgIGRlcGVuZGFudElkOiBEeW5hbW9BdHRyaWJ1dGVWYWx1ZS5mcm9tU3RyaW5nKFxuICAgICAgICAgICAgSnNvblBhdGguZm9ybWF0KFwiTk9ERXx7fVwiLCBKc29uUGF0aC5zdHJpbmdBdChcIiQubm9kZS5pZFwiKSlcbiAgICAgICAgICApLFxuICAgICAgICAgIGRlcGVuZGFudFZlcnNpb246IER5bmFtb0F0dHJpYnV0ZVZhbHVlLmZyb21TdHJpbmcoXG4gICAgICAgICAgICBKc29uUGF0aC5zdHJpbmdBdChcIiQkLkV4ZWN1dGlvbi5TdGFydFRpbWVcIilcbiAgICAgICAgICApLFxuICAgICAgICB9LFxuICAgICAgfVxuICAgICk7XG4gICAgY29uc3QgZ2V0T3V0ZGF0ZWREZXBlbmRlbmNpZXMgPSBuZXcgRHluYW1vRXhlY3V0ZVN0YXRlbWVudChcbiAgICAgIHNjb3BlLFxuICAgICAgYCR7aWR9R2V0T3V0ZGF0ZWREZXBlbmRlbmNpZXNgLFxuICAgICAge1xuICAgICAgICB0YWJsZTogZHluYW1vVGFibGUsXG4gICAgICAgIHN0YXRlbWVudDogSnNvblBhdGguZm9ybWF0KFxuICAgICAgICAgIGBTRUxFQ1QgKiBGUk9NIFwiJHtkeW5hbW9UYWJsZS50YWJsZU5hbWV9XCIgV0hFUkUgUEsgPSAnTk9ERXx7fScgQU5EIGJlZ2luc193aXRoKFNLLCdERVBFTkRFTkNZfE5PREV8JykgQU5EIGRlcGVuZGFudFZlcnNpb24gPCA/YCxcbiAgICAgICAgICBKc29uUGF0aC5zdHJpbmdBdChcIiQubm9kZS5pZFwiKVxuICAgICAgICApLFxuICAgICAgICBwYXJhbWV0ZXJzOiBbXG4gICAgICAgICAgRHluYW1vQXR0cmlidXRlVmFsdWUuZnJvbVN0cmluZyhcbiAgICAgICAgICAgIEpzb25QYXRoLnN0cmluZ0F0KFwiJCQuRXhlY3V0aW9uLlN0YXJ0VGltZVwiKVxuICAgICAgICAgICksXG4gICAgICAgIF0sXG4gICAgICAgIHJlc3VsdFBhdGg6IEpzb25QYXRoLnN0cmluZ0F0KFwiJC5pbnZhbGlkRGVwZW5kZW5jaWVzXCIpLFxuICAgICAgfVxuICAgICk7XG5cbiAgICBjb25zdCBkZWxldGVPdXRkYXRlZERlcGVuZGVuY2llID0gbmV3IER5bmFtb0RlbGV0ZUl0ZW0oXG4gICAgICBzY29wZSxcbiAgICAgIGAke2lkfUdldE91dGRhdGVkRGVwZW5kZW5jaWVgLFxuICAgICAge1xuICAgICAgICB0YWJsZTogZHluYW1vVGFibGUsXG4gICAgICAgIGtleToge1xuICAgICAgICAgIFBLOiBEeW5hbW9BdHRyaWJ1dGVWYWx1ZS5mcm9tU3RyaW5nKFxuICAgICAgICAgICAgSnNvblBhdGguc3RyaW5nQXQoXCIkLmRlcGVuZGVuY3kuUEsuU1wiKVxuICAgICAgICAgICksXG4gICAgICAgICAgU0s6IER5bmFtb0F0dHJpYnV0ZVZhbHVlLmZyb21TdHJpbmcoXG4gICAgICAgICAgICBKc29uUGF0aC5zdHJpbmdBdChcIiQuZGVwZW5kZW5jeS5TSy5TXCIpXG4gICAgICAgICAgKSxcbiAgICAgICAgfSxcbiAgICAgICAgcmVzdWx0UGF0aDogSnNvblBhdGguc3RyaW5nQXQoXCIkLmludmFsaWREZXBlbmRlbmNpZXNcIiksXG4gICAgICB9XG4gICAgKTtcbiAgICByZXR1cm4gbmV3IE1hcChzY29wZSwgXCJNYXBQdXROb2Rlc1wiLCB7XG4gICAgICBpdGVtc1BhdGg6IEpzb25QYXRoLnN0cmluZ0F0KFwiJC5ub2Rlc1wiKSxcbiAgICAgIHBhcmFtZXRlcnM6IHtcbiAgICAgICAgbm9kZTogSnNvblBhdGguc3RyaW5nQXQoXCIkJC5NYXAuSXRlbS5WYWx1ZVwiKSxcbiAgICAgIH0sXG4gICAgfSkuaXRlcmF0b3IoXG4gICAgICBwdXROb2RlXG4gICAgICAgIC5uZXh0KFxuICAgICAgICAgIG5ldyBNYXAoc2NvcGUsIFwiU3RvcmVEZXBlbmRlbmNpZXNcIiwge1xuICAgICAgICAgICAgaXRlbXNQYXRoOiBKc29uUGF0aC5zdHJpbmdBdChcIiQubm9kZS5kZXBlbmRlbmNpZXNcIiksXG4gICAgICAgICAgICBwYXJhbWV0ZXJzOiB7XG4gICAgICAgICAgICAgIGRlcGVuZGVuY3k6IEpzb25QYXRoLnN0cmluZ0F0KFwiJCQuTWFwLkl0ZW0uVmFsdWVcIiksXG4gICAgICAgICAgICAgIG5vZGU6IEpzb25QYXRoLnN0cmluZ0F0KFwiJC5ub2RlXCIpLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHJlc3VsdFBhdGg6IEpzb25QYXRoLkRJU0NBUkQsXG4gICAgICAgICAgfSkuaXRlcmF0b3Ioc3RvcmVEZXBlbmRlZUVkZ2UpXG4gICAgICAgIClcbiAgICAgICAgLm5leHQoXG4gICAgICAgICAgZ2V0T3V0ZGF0ZWREZXBlbmRlbmNpZXMubmV4dChcbiAgICAgICAgICAgIG5ldyBNYXAoc2NvcGUsIFwiRGVsZXRlT3V0ZGF0ZWREZXBlbmRlbmNpZXNcIiwge1xuICAgICAgICAgICAgICBpdGVtc1BhdGg6IEpzb25QYXRoLnN0cmluZ0F0KFwiJC5pbnZhbGlkRGVwZW5kZW5jaWVzLkl0ZW1zXCIpLFxuICAgICAgICAgICAgICBwYXJhbWV0ZXJzOiB7XG4gICAgICAgICAgICAgICAgZGVwZW5kZW5jeTogSnNvblBhdGguc3RyaW5nQXQoXCIkJC5NYXAuSXRlbS5WYWx1ZVwiKSxcbiAgICAgICAgICAgICAgICBub2RlOiBKc29uUGF0aC5zdHJpbmdBdChcIiQubm9kZVwiKSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0pLml0ZXJhdG9yKGRlbGV0ZU91dGRhdGVkRGVwZW5kZW5jaWUpXG4gICAgICAgICAgKVxuICAgICAgICApXG4gICAgKTtcbiAgfVxufVxuIl19